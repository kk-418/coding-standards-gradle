/**
 * Javaç¼–ç è§„èŒƒçº¦æŸ
 *
 * ä½œè€…: kk
 * åˆ›å»ºæ—¥æœŸ: 2025-10-01
 * è§„èŒƒæ¥æº: ~/.claude/coding-standards/java-coding-standards.md
 */

// æ£€æŸ¥æšä¸¾ç±»å‘½åè§„èŒƒ
tasks.register('checkEnumNaming') {
    group = 'verification'
    description = 'æ£€æŸ¥æšä¸¾ç±»æ˜¯å¦ä»¥Enumç»“å°¾'

    doLast {
        def violations = []
        def javaFiles = fileTree(dir: 'src/main/java', include: '**/*.java')

        javaFiles.each { file ->
            def content = file.text

            // æ£€æµ‹æšä¸¾ç±»å®šä¹‰
            if (content =~ /public\s+enum\s+(\w+)/) {
                def matcher = content =~ /public\s+enum\s+(\w+)/
                while (matcher.find()) {
                    def enumName = matcher.group(1)
                    if (!enumName.endsWith('Enum')) {
                        violations << "${file.path} - æšä¸¾ç±»åº”ä»¥Enumç»“å°¾: ${enumName}"
                    }
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âŒ æšä¸¾ç±»å‘½åæ£€æŸ¥å¤±è´¥ï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\nå‘½åè§„èŒƒ: æšä¸¾ç±»å¿…é¡»ä»¥Enumç»“å°¾ï¼ˆå¦‚PaymentStatusEnumã€OrderTypeEnumï¼‰"
            println "="*60 + "\n"
            throw new GradleException("Javaç¼–ç è§„èŒƒæ£€æŸ¥å¤±è´¥ï¼šæšä¸¾ç±»å‘½åä¸ç¬¦åˆè§„èŒƒ")
        } else {
            println "âœ… æšä¸¾ç±»å‘½åæ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥ç±»å‘½åè§„èŒƒ
tasks.register('checkClassNaming') {
    group = 'verification'
    description = 'æ£€æŸ¥ç±»å‘½åæ˜¯å¦ç¬¦åˆè§„èŒƒï¼ˆService/ServiceImpl/Repositoryç­‰ï¼‰'

    doLast {
        def violations = []
        def javaFiles = fileTree(dir: 'src/main/java', include: '**/*.java')

        javaFiles.each { file ->
            def fileName = file.name
            def content = file.text

            // æ£€æŸ¥Serviceå®ç°ç±»
            if (content.contains('implements') && content =~ /Service\s/) {
                if (!fileName.endsWith('ServiceImpl.java') && fileName.contains('Service')) {
                    // æ’é™¤æ¥å£å®šä¹‰
                    if (!content.contains('interface ')) {
                        violations << "${file.path} - Serviceå®ç°ç±»åº”ä»¥ServiceImplç»“å°¾"
                    }
                }
            }

            // æ£€æŸ¥VOç±»å‘½å
            if (fileName.endsWith('VO.java') || fileName.endsWith('Vo.java')) {
                if (!content.contains('record ') && !content.contains('class ')) {
                    violations << "${file.path} - VOç±»å®šä¹‰å¼‚å¸¸"
                }
            }

            // æ£€æŸ¥Controllerç±»
            if (content.contains('@RestController') || content.contains('@Controller')) {
                if (!fileName.endsWith('Controller.java')) {
                    violations << "${file.path} - Controllerç±»åº”ä»¥Controllerç»“å°¾"
                }
            }

            // æ£€æŸ¥Repository/Mapperæ¥å£
            if (content.contains('extends BaseMapper')) {
                if (!fileName.endsWith('Mapper.java') && !fileName.endsWith('Repository.java')) {
                    violations << "${file.path} - Mapperæ¥å£åº”ä»¥Mapperæˆ–Repositoryç»“å°¾"
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âš ï¸  ç±»å‘½åè§„èŒƒæ£€æŸ¥è­¦å‘Šï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\nå‘½åè§„èŒƒ:"
            println "  - Serviceå®ç°: *ServiceImpl"
            println "  - Controller: *Controller"
            println "  - Mapper: *Mapper æˆ– *Repository"
            println "  - VO: *VO"
            println "="*60 + "\n"
            // æ³¨æ„ï¼šç±»å‘½åæ£€æŸ¥ä»…è­¦å‘Šï¼Œä¸ä¸­æ–­ç¼–è¯‘
        } else {
            println "âœ… ç±»å‘½åè§„èŒƒæ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥Lombokæ³¨è§£ä½¿ç”¨
tasks.register('checkLombokAnnotations') {
    group = 'verification'
    description = 'æ£€æŸ¥Lombokæ³¨è§£ä½¿ç”¨æ˜¯å¦ç¬¦åˆè§„èŒƒï¼ˆé¿å…@SneakyThrowsï¼‰'

    doLast {
        def violations = []
        def javaFiles = fileTree(dir: 'src/main/java', include: '**/*.java')

        javaFiles.each { file ->
            def lineNumber = 0

            file.eachLine { line, num ->
                lineNumber = num

                // æ£€æµ‹ä¸æ¨èçš„Lombokæ³¨è§£
                if (line.contains('@SneakyThrows')) {
                    violations << "${file.path}:${lineNumber} - ä¸æ¨èä½¿ç”¨@SneakyThrowsï¼Œå»ºè®®æ˜¾å¼å¼‚å¸¸å¤„ç†"
                }

                if (line.contains('@Synchronized')) {
                    violations << "${file.path}:${lineNumber} - ä¸æ¨èä½¿ç”¨@Synchronizedï¼Œå»ºè®®ä½¿ç”¨JavaåŸç”Ÿsynchronized"
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âš ï¸  Lombokæ³¨è§£ä½¿ç”¨è­¦å‘Šï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\næ¨èåšæ³•:"
            println "  - é¿å…@SneakyThrowsï¼Œä½¿ç”¨try-catchæ˜¾å¼å¤„ç†å¼‚å¸¸"
            println "  - é¿å…@Synchronizedï¼Œä½¿ç”¨synchronizedå…³é”®å­—"
            println "="*60 + "\n"
            // æ³¨æ„ï¼šLombokæ³¨è§£æ£€æŸ¥ä»…è­¦å‘Šï¼Œä¸ä¸­æ–­ç¼–è¯‘
        } else {
            println "âœ… Lombokæ³¨è§£ä½¿ç”¨æ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥ResultåµŒå¥—PageResult
tasks.register('checkResultPageResultNesting') {
    group = 'verification'
    description = 'æ£€æŸ¥æ˜¯å¦å­˜åœ¨Result<PageResult>åµŒå¥—ä½¿ç”¨'

    doLast {
        def violations = []
        def javaFiles = fileTree(dir: 'src/main/java', include: '**/*.java')

        javaFiles.each { file ->
            def lineNumber = 0

            file.eachLine { line, num ->
                lineNumber = num

                // æ£€æµ‹Result<PageResult>åµŒå¥—
                if (line =~ /Result\s*<\s*PageResult\s*</) {
                    violations << "${file.path}:${lineNumber} - ç¦æ­¢ä½¿ç”¨Result<PageResult>åµŒå¥—ï¼Œåˆ†é¡µæŸ¥è¯¢ç›´æ¥è¿”å›PageResult"
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âŒ Result/PageResultåµŒå¥—æ£€æŸ¥å¤±è´¥ï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\næ­£ç¡®åšæ³•:"
            println "  - æ™®é€šæŸ¥è¯¢: Result<T>"
            println "  - åˆ†é¡µæŸ¥è¯¢: PageResult<T>"
            println "  - ç¦æ­¢ä½¿ç”¨: Result<PageResult<T>>"
            println "="*60 + "\n"
            throw new GradleException("Javaç¼–ç è§„èŒƒæ£€æŸ¥å¤±è´¥ï¼šå­˜åœ¨Result<PageResult>åµŒå¥—")
        } else {
            println "âœ… Result/PageResultåµŒå¥—æ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥Recordç±»ä½¿ç”¨è§„èŒƒ
tasks.register('checkRecordUsage') {
    group = 'verification'
    description = 'æ£€æŸ¥Recordç±»æ˜¯å¦ç”¨äºDTO/VO/Request/Response'

    doLast {
        def violations = []
        def recommendRecordFiles = []
        def javaFiles = fileTree(dir: 'src/main/java', include: '**/*.java')

        javaFiles.each { file ->
            def fileName = file.name
            def content = file.text

            // æ£€æŸ¥DTO/VO/Request/Responseæ˜¯å¦ä½¿ç”¨Record
            if (fileName.endsWith('DTO.java') ||
                fileName.endsWith('Dto.java') ||
                fileName.endsWith('VO.java') ||
                fileName.endsWith('Vo.java') ||
                fileName.endsWith('Request.java') ||
                fileName.endsWith('Response.java')) {

                // æ’é™¤å·²ç»æ˜¯Recordçš„
                if (!content.contains('record ')) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ç®€å•çš„æ•°æ®ç±»ï¼ˆæ²¡æœ‰å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼‰
                    if (!content.contains('public void ') &&
                        !content.contains('private void ') &&
                        !content.contains('@Service') &&
                        !content.contains('@Component')) {
                        recommendRecordFiles << "${file.path} - å»ºè®®ä½¿ç”¨Recordç±»å®šä¹‰"
                    }
                }
            }
        }

        if (!recommendRecordFiles.isEmpty()) {
            println "\n" + "="*60
            println "ğŸ’¡ Recordç±»ä½¿ç”¨å»ºè®®ï¼å‘ç° ${recommendRecordFiles.size()} ä¸ªå¯ä¼˜åŒ–é¡¹:"
            println "="*60
            recommendRecordFiles.take(10).each { println it }
            if (recommendRecordFiles.size() > 10) {
                println "... è¿˜æœ‰ ${recommendRecordFiles.size() - 10} ä¸ªå»ºè®®æœªæ˜¾ç¤º"
            }
            println "\nRecordç±»ä¼˜åŠ¿:"
            println "  - ç®€æ´çš„ä¸å¯å˜æ•°æ®å¯¹è±¡"
            println "  - è‡ªåŠ¨ç”Ÿæˆequals/hashCode/toString"
            println "  - é€‚ç”¨äºDTO/VO/Request/Response"
            println "="*60 + "\n"
            // æ³¨æ„ï¼šRecordä½¿ç”¨å»ºè®®ä»…æç¤ºï¼Œä¸ä¸­æ–­ç¼–è¯‘
        } else {
            println "âœ… Recordç±»ä½¿ç”¨æ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥æšä¸¾fromCodeæ–¹æ³•
tasks.register('checkEnumFromCodeMethod') {
    group = 'verification'
    description = 'æ£€æŸ¥æšä¸¾ç±»æ˜¯å¦æä¾›fromCodeé™æ€æ–¹æ³•'

    doLast {
        def violations = []
        def javaFiles = fileTree(dir: 'src/main/java', include: '**/*.java')

        javaFiles.each { file ->
            def content = file.text

            // åªæ£€æŸ¥æšä¸¾ç±»
            if (content =~ /public\s+enum\s+\w+/) {
                // æ£€æŸ¥æ˜¯å¦æœ‰codeå­—æ®µ
                if (content.contains('private final String code') ||
                    content.contains('private String code')) {

                    // æ£€æŸ¥æ˜¯å¦æœ‰fromCodeæ–¹æ³•
                    if (!content.contains('fromCode')) {
                        violations << "${file.path} - æšä¸¾ç±»å®šä¹‰äº†codeå­—æ®µä½†ç¼ºå°‘fromCode()æ–¹æ³•"
                    }
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âš ï¸  æšä¸¾fromCodeæ–¹æ³•æ£€æŸ¥è­¦å‘Šï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\nå»ºè®®æ·»åŠ æ–¹æ³•:"
            println "  public static XXXEnum fromCode(String code) {"
            println "      return Arrays.stream(values())"
            println "          .filter(e -> e.code.equals(code))"
            println "          .findFirst()"
            println "          .orElseThrow(() -> new IllegalArgumentException(\"æœªçŸ¥code: \" + code));"
            println "  }"
            println "="*60 + "\n"
            // æ³¨æ„ï¼šfromCodeæ–¹æ³•æ£€æŸ¥ä»…è­¦å‘Šï¼Œä¸ä¸­æ–­ç¼–è¯‘
        } else {
            println "âœ… æšä¸¾fromCodeæ–¹æ³•æ£€æŸ¥é€šè¿‡"
        }
    }
}

// ç»¼åˆæ£€æŸ¥ä»»åŠ¡
tasks.register('checkJavaCodingStandards') {
    group = 'verification'
    description = 'æ‰§è¡Œæ‰€æœ‰Javaç¼–ç è§„èŒƒæ£€æŸ¥'

    dependsOn checkEnumNaming
    dependsOn checkClassNaming
    dependsOn checkLombokAnnotations
    dependsOn checkResultPageResultNesting
    dependsOn checkRecordUsage
    dependsOn checkEnumFromCodeMethod
}

println "âœ“ Javaç¼–ç è§„èŒƒçº¦æŸå·²åŠ è½½ (java-coding-standards.gradle)"
