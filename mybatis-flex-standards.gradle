/**
 * MyBatis-Flexè§„èŒƒçº¦æŸ
 *
 * ä½œè€…: kk
 * åˆ›å»ºæ—¥æœŸ: 2025-10-01
 * è§„èŒƒæ¥æº: ~/.claude/coding-standards/mybatis-flex-standards.md
 */

// æ£€æŸ¥Entityæ³¨è§£
tasks.register('checkEntityAnnotations') {
    group = 'verification'
    description = 'æ£€æŸ¥Entityå®ä½“ç±»æ˜¯å¦æ­£ç¡®ä½¿ç”¨MyBatis-Flexæ³¨è§£'

    doLast {
        def violations = []
        def entityFiles = fileTree(dir: 'src/main/java', include: '**/*entity/**/*.java')

        entityFiles.each { file ->
            def content = file.text
            def fileName = file.name

            // è·³è¿‡Enumã€æ¥å£ã€æŠ½è±¡ç±»
            if (content.contains('enum ') || content.contains('interface ') || content.contains('abstract class')) {
                return
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰@Tableæ³¨è§£
            if (!content.contains('@Table')) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å®ä½“ç±»ï¼ˆæœ‰privateå­—æ®µä¸”ä¸æ˜¯å·¥å…·ç±»ï¼‰
                if (content.contains('private ') && !fileName.contains('Util') && !fileName.contains('Helper')) {
                    violations << "${file.path} - Entityç±»ç¼ºå°‘@Tableæ³¨è§£"
                }
            } else {
                // å¦‚æœæœ‰@Tableæ³¨è§£ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰@Idæ³¨è§£
                if (!content.contains('@Id')) {
                    violations << "${file.path} - Entityç±»ç¼ºå°‘@Idä¸»é”®æ³¨è§£"
                }

                // æ£€æŸ¥ä¸»é”®æ˜¯å¦æŒ‡å®šäº†keyType
                if (content.contains('@Id') && !content.contains('keyType')) {
                    violations << "${file.path} - @Idæ³¨è§£ç¼ºå°‘keyTypeå±æ€§"
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âŒ Entityæ³¨è§£æ£€æŸ¥å¤±è´¥ï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\næ­£ç¡®ç¤ºä¾‹:"
            println "  @Table(\"table_name\")"
            println "  public class EntityName {"
            println "      @Id(keyType = KeyType.Auto)"
            println "      private Long id;"
            println "  }"
            println "="*60 + "\n"
            throw new GradleException("MyBatis-Flexè§„èŒƒæ£€æŸ¥å¤±è´¥ï¼šEntityæ³¨è§£ç¼ºå¤±æˆ–ä¸å®Œæ•´")
        } else {
            println "âœ… Entityæ³¨è§£æ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥Mapperæ¥å£ç»§æ‰¿BaseMapper
tasks.register('checkMapperInterface') {
    group = 'verification'
    description = 'æ£€æŸ¥Mapperæ¥å£æ˜¯å¦ç»§æ‰¿BaseMapper'

    doLast {
        def violations = []
        def mapperFiles = fileTree(dir: 'src/main/java', include: '**/*mapper/**/*.java') +
                          fileTree(dir: 'src/main/java', include: '**/*repository/**/*.java')

        mapperFiles.each { file ->
            def content = file.text
            def fileName = file.name

            // åªæ£€æŸ¥æ¥å£æ–‡ä»¶
            if (!content.contains('interface ')) {
                return
            }

            // æ£€æŸ¥æ˜¯å¦ç»§æ‰¿BaseMapper
            if (!content.contains('extends BaseMapper')) {
                violations << "${file.path} - Mapperæ¥å£åº”ç»§æ‰¿BaseMapper<T>"
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âŒ Mapperæ¥å£æ£€æŸ¥å¤±è´¥ï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\næ­£ç¡®ç¤ºä¾‹:"
            println "  public interface PaymentMapper extends BaseMapper<Payment> {"
            println "      // ç»§æ‰¿BaseMapperåè‡ªåŠ¨æ‹¥æœ‰CRUDæ–¹æ³•"
            println "  }"
            println "="*60 + "\n"
            throw new GradleException("MyBatis-Flexè§„èŒƒæ£€æŸ¥å¤±è´¥ï¼šMapperæœªç»§æ‰¿BaseMapper")
        } else {
            println "âœ… Mapperæ¥å£æ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥æšä¸¾@EnumValueæ³¨è§£
tasks.register('checkEnumValueAnnotation') {
    group = 'verification'
    description = 'æ£€æŸ¥æšä¸¾ç±»æ˜¯å¦æ­£ç¡®ä½¿ç”¨@EnumValueæ³¨è§£'

    doLast {
        def violations = []
        def recommendEnumValue = []
        def enumFiles = fileTree(dir: 'src/main/java', include: '**/*Enum.java')

        enumFiles.each { file ->
            def content = file.text

            // åªæ£€æŸ¥æšä¸¾ç±»
            if (!content.contains('enum ')) {
                return
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰codeå­—æ®µ
            if (content.contains('private final String code') ||
                content.contains('private String code')) {

                // æ£€æŸ¥æ˜¯å¦æœ‰@EnumValueæ³¨è§£
                if (!content.contains('@EnumValue')) {
                    recommendEnumValue << "${file.path} - æšä¸¾ç±»å®šä¹‰äº†codeå­—æ®µï¼Œå»ºè®®ä½¿ç”¨@EnumValueæ³¨è§£"
                }
            }
        }

        if (!recommendEnumValue.isEmpty()) {
            println "\n" + "="*60
            println "ğŸ’¡ æšä¸¾@EnumValueæ³¨è§£å»ºè®®ï¼å‘ç° ${recommendEnumValue.size()} ä¸ªå¯ä¼˜åŒ–é¡¹:"
            println "="*60
            recommendEnumValue.each { println it }
            println "\næ­£ç¡®ç¤ºä¾‹:"
            println "  public enum PaymentStatusEnum {"
            println "      PAID(\"PAID\", \"å·²æ”¯ä»˜\"),"
            println "      CANCELLED(\"CANCELLED\", \"å·²å–æ¶ˆ\");"
            println ""
            println "      @EnumValue  // æ ‡è®°æ­¤å­—æ®µç”¨äºæ•°æ®åº“å­˜å‚¨"
            println "      private final String code;"
            println "      private final String description;"
            println "  }"
            println "="*60 + "\n"
            // æ³¨æ„ï¼š@EnumValueæ£€æŸ¥ä»…å»ºè®®ï¼Œä¸ä¸­æ–­ç¼–è¯‘
        } else {
            println "âœ… æšä¸¾@EnumValueæ³¨è§£æ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥é€»è¾‘åˆ é™¤å­—æ®µé…ç½®
tasks.register('checkLogicDeleteField') {
    group = 'verification'
    description = 'æ£€æŸ¥Entityçš„é€»è¾‘åˆ é™¤å­—æ®µæ˜¯å¦æ­£ç¡®é…ç½®'

    doLast {
        def violations = []
        def entityFiles = fileTree(dir: 'src/main/java', include: '**/*entity/**/*.java')

        entityFiles.each { file ->
            def content = file.text

            // è·³è¿‡éå®ä½“ç±»
            if (!content.contains('@Table')) {
                return
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰isDeletedå­—æ®µ
            if (content.contains('private') && content =~ /private\s+\w+\s+isDeleted/) {
                // æ£€æŸ¥æ˜¯å¦æ ‡æ³¨äº†é€»è¾‘åˆ é™¤æ³¨è§£
                if (!content.contains('isLogicDelete = true')) {
                    violations << "${file.path} - isDeletedå­—æ®µç¼ºå°‘@Column(isLogicDelete = true)æ³¨è§£"
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âŒ é€»è¾‘åˆ é™¤å­—æ®µæ£€æŸ¥å¤±è´¥ï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\næ­£ç¡®ç¤ºä¾‹:"
            println "  @Column(isLogicDelete = true)"
            println "  private Integer isDeleted;"
            println "="*60 + "\n"
            throw new GradleException("MyBatis-Flexè§„èŒƒæ£€æŸ¥å¤±è´¥ï¼šé€»è¾‘åˆ é™¤å­—æ®µé…ç½®é”™è¯¯")
        } else {
            println "âœ… é€»è¾‘åˆ é™¤å­—æ®µæ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥ä¹è§‚é”ç‰ˆæœ¬å·å­—æ®µ
tasks.register('checkVersionField') {
    group = 'verification'
    description = 'æ£€æŸ¥Entityçš„ä¹è§‚é”ç‰ˆæœ¬å·å­—æ®µæ˜¯å¦æ­£ç¡®é…ç½®'

    doLast {
        def violations = []
        def entityFiles = fileTree(dir: 'src/main/java', include: '**/*entity/**/*.java')

        entityFiles.each { file ->
            def content = file.text

            // è·³è¿‡éå®ä½“ç±»
            if (!content.contains('@Table')) {
                return
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰versionå­—æ®µ
            if (content.contains('private') && content =~ /private\s+\w+\s+version/) {
                // æ£€æŸ¥æ˜¯å¦æ ‡æ³¨äº†ä¹è§‚é”æ³¨è§£
                if (!content.contains('version = true')) {
                    violations << "${file.path} - versionå­—æ®µç¼ºå°‘@Column(version = true)æ³¨è§£"
                }
            }
        }

        if (!violations.isEmpty()) {
            println "\n" + "="*60
            println "âŒ ä¹è§‚é”ç‰ˆæœ¬å·å­—æ®µæ£€æŸ¥å¤±è´¥ï¼å‘ç° ${violations.size()} ä¸ªé—®é¢˜:"
            println "="*60
            violations.each { println it }
            println "\næ­£ç¡®ç¤ºä¾‹:"
            println "  @Column(version = true)"
            println "  private Integer version;"
            println "="*60 + "\n"
            throw new GradleException("MyBatis-Flexè§„èŒƒæ£€æŸ¥å¤±è´¥ï¼šä¹è§‚é”ç‰ˆæœ¬å·å­—æ®µé…ç½®é”™è¯¯")
        } else {
            println "âœ… ä¹è§‚é”ç‰ˆæœ¬å·å­—æ®µæ£€æŸ¥é€šè¿‡"
        }
    }
}

// æ£€æŸ¥æ—¶é—´å­—æ®µè‡ªåŠ¨å¡«å……
tasks.register('checkTimeFieldAutoFill') {
    group = 'verification'
    description = 'æ£€æŸ¥Entityçš„æ—¶é—´å­—æ®µæ˜¯å¦é…ç½®è‡ªåŠ¨å¡«å……'

    doLast {
        def recommendations = []
        def entityFiles = fileTree(dir: 'src/main/java', include: '**/*entity/**/*.java')

        entityFiles.each { file ->
            def content = file.text

            // è·³è¿‡éå®ä½“ç±»
            if (!content.contains('@Table')) {
                return
            }

            // æ£€æŸ¥createTimeå­—æ®µ
            if (content =~ /private\s+LocalDateTime\s+createTime/) {
                if (!content.contains('onInsertValue')) {
                    recommendations << "${file.path} - createTimeå­—æ®µå»ºè®®é…ç½®onInsertValueè‡ªåŠ¨å¡«å……"
                }
            }

            // æ£€æŸ¥updateTimeå­—æ®µ
            if (content =~ /private\s+LocalDateTime\s+updateTime/) {
                if (!content.contains('onUpdateValue')) {
                    recommendations << "${file.path} - updateTimeå­—æ®µå»ºè®®é…ç½®onUpdateValueè‡ªåŠ¨å¡«å……"
                }
            }
        }

        if (!recommendations.isEmpty()) {
            println "\n" + "="*60
            println "ğŸ’¡ æ—¶é—´å­—æ®µè‡ªåŠ¨å¡«å……å»ºè®®ï¼å‘ç° ${recommendations.size()} ä¸ªå¯ä¼˜åŒ–é¡¹:"
            println "="*60
            recommendations.take(10).each { println it }
            if (recommendations.size() > 10) {
                println "... è¿˜æœ‰ ${recommendations.size() - 10} ä¸ªå»ºè®®æœªæ˜¾ç¤º"
            }
            println "\næ¨èé…ç½®:"
            println "  @Column(value = \"create_time\", onInsertValue = \"now()\")"
            println "  private LocalDateTime createTime;"
            println ""
            println "  @Column(value = \"update_time\", onInsertValue = \"now()\", onUpdateValue = \"now()\")"
            println "  private LocalDateTime updateTime;"
            println "="*60 + "\n"
            // æ³¨æ„ï¼šæ—¶é—´å­—æ®µè‡ªåŠ¨å¡«å……ä»…å»ºè®®ï¼Œä¸ä¸­æ–­ç¼–è¯‘
        } else {
            println "âœ… æ—¶é—´å­—æ®µè‡ªåŠ¨å¡«å……æ£€æŸ¥é€šè¿‡"
        }
    }
}

// ç»¼åˆæ£€æŸ¥ä»»åŠ¡
tasks.register('checkMyBatisFlexStandards') {
    group = 'verification'
    description = 'æ‰§è¡Œæ‰€æœ‰MyBatis-Flexè§„èŒƒæ£€æŸ¥'

    dependsOn checkEntityAnnotations
    dependsOn checkMapperInterface
    dependsOn checkEnumValueAnnotation
    dependsOn checkLogicDeleteField
    dependsOn checkVersionField
    dependsOn checkTimeFieldAutoFill
}

println "âœ“ MyBatis-Flexè§„èŒƒçº¦æŸå·²åŠ è½½ (mybatis-flex-standards.gradle)"
